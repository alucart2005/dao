---
globs: **/scripts/**/*.js,**/app/api/sync-contracts/**/*.ts
description: Contract address synchronization system
---

# Contract Address Synchronization

## Automatic Sync

Contract addresses are automatically synchronized before `npm run dev` and `npm run build` via the `predev` and `prebuild` hooks in [package.json](mdc:web/package.json).

## Script: sync-contracts.js

The [sync-contracts.js](mdc:web/scripts/sync-contracts.js) script:

1. Reads contract addresses from Foundry broadcast files (`sc/broadcast/DeployLocal.s.sol/{CHAIN_ID}/run-*.json`)
2. Falls back to blockchain verification if broadcast files not found
3. Compares with current `.env.local` addresses
4. Updates `.env.local` if differences found
5. Verifies contracts exist on blockchain (warning only, doesn't block)

## Usage

```bash
# Automatic (runs before dev/build)
npm run dev

# Manual
npm run sync-contracts
npm run sync-contracts:force      # Force update even if no changes
npm run sync-contracts:verbose    # Detailed logging
```

## API Endpoint

The sync can also be triggered via API:

```typescript
// GET /api/sync-contracts
// GET /api/sync-contracts?force=true
// GET /api/sync-contracts?verbose=true

// POST /api/sync-contracts
// Body: { "force": true, "verbose": true }
```

See [app/api/sync-contracts/route.ts](mdc:web/app/api/sync-contracts/route.ts) for implementation.

## Important Notes

- The script normalizes addresses (case-insensitive comparison)
- It doesn't block execution if contracts aren't deployed (shows warnings)
- Always verify contract deployment after Anvil restarts
- Broadcast files are generated by `forge script --broadcast`
